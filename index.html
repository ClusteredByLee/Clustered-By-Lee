<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Clustered by Lee | Luxury Lash Enhancements</title>
  <meta name="description" content="Clustered by Lee — clustered lashes, glam bundles, and kits. Order via WhatsApp with delivery options."/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg:#fff7fb;
      --panel:#ffffff;
      --text:#231f20;
      --muted:#6b7280;
      --border:#f6d8ea;
      --accent:#ec4899;
      --accent-700:#db2777;
      --accent-soft:#fde7f2;
      --accent-soft-2:#fff0f7;
      --success:#22c55e;

      --radius:14px;
      --shadow:0 14px 44px rgba(236,72,153,.18);
      --shadow-2:0 16px 60px rgba(236,72,153,.28);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,var(--bg), #ffffff);
      color:var(--text);
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica Neue, Arial;
    }
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    .container{width:min(1200px,calc(100% - 2rem));margin:0 auto}

    /* Header */
    .header{
      position:sticky;top:0;z-index:50;
      background:rgba(255,255,255,.85);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
    }
    .nav{display:flex;align-items:center;justify-content:space-between;padding:.8rem 0}
    .brand{display:flex;align-items:center;gap:.6rem;font-weight:900;letter-spacing:.02em}
    .brand .logo{width:36px;height:36px;border-radius:10px;object-fit:cover;box-shadow:var(--shadow)}
    .brand .name{font-size:1.1rem;color:var(--accent-700);text-transform:uppercase;letter-spacing:.12em}
    .nav-links{display:flex;align-items:center;gap:.4rem}
    .nav-link{padding:.55rem .85rem;border-radius:.7rem;color:#6b7280;font-weight:700}
    .nav-link:hover,.nav-link.active{background:var(--accent-soft);color:#a31257}
    .btn{
      display:inline-flex;align-items:center;gap:.5rem;
      padding:.6rem .9rem;border-radius:.8rem;border:1px solid var(--accent);
      background:linear-gradient(180deg,var(--accent), var(--accent-700));color:#fff;
      font-weight:900;letter-spacing:.02em;box-shadow:var(--shadow);
      transition:transform .06s, filter .2s;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn-outline{
      background:var(--accent-soft);color:#a31257;border-color:var(--accent);
    }
    .btn-outline:hover{background:#ffd8eb}
    .btn-small{padding:.45rem .7rem;font-size:.9rem}

    /* Pages */
    .page{display:none}
    .page.active{display:block}

    /* Hero */
    .hero{
      position:relative;overflow:hidden;border-bottom:1px solid var(--border);
      background:
        radial-gradient(1200px 400px at 10% -10%, #ffe3f2 0%, transparent 60%),
        radial-gradient(900px 400px at 90% 0%, #ffd2ec 0%, transparent 60%),
        linear-gradient(180deg,#ffffff, var(--accent-soft-2) 70%);
    }
    .hero-inner{
      display:grid;grid-template-columns:1.1fr .9fr;gap:2rem;align-items:center;padding:3rem 0;
    }
    .hero h1{margin:0;font-size:clamp(2rem,4.5vw,3.2rem);line-height:1.06}
    .hero p{color:var(--muted);margin:.6rem 0 1rem;font-size:1.05rem}
    .cta{display:flex;gap:.6rem;flex-wrap:wrap}
    .hero-visual{
      border-radius:18px;border:1px solid var(--border);box-shadow:var(--shadow-2);
      overflow:hidden;background:#fff
    }
    .hero-visual img{width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .5s ease}

    /* Sections */
    .section{padding:2rem 0}
    .section h2{margin:.25rem 0;font-size:1.35rem}
    .muted{color:var(--muted)}

    /* Grid / Cards */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:1rem}
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;display:grid;grid-template-rows:auto 1fr auto;
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .card:hover{transform:translateY(-3px);box-shadow:0 18px 44px rgba(236,72,153,.28);border-color:#ffcfe8}
    .card img{aspect-ratio:4/3;object-fit:cover}
    .card-body{padding:1rem}
    .card h3{margin:0 0 .4rem}
    .price{font-weight:900;color:#9d174d}
    .price-row{display:flex;align-items:center;justify-content:space-between;gap:.5rem}
    .compare{color:#9ca3af;text-decoration:line-through;margin-left:.35rem;font-weight:600}
    .save{color:var(--success);font-weight:900;font-size:.9rem;margin-left:.35rem}
    .small{font-size:.9rem;color:#6b7280}
    .card-actions{display:flex;gap:.5rem;padding:1rem;border-top:1px solid var(--border)}
    .pill{background:#ffeaf4;color:#a31257;font-weight:800;padding:.25rem .55rem;border-radius:999px;font-size:.75rem;display:inline-block}

    /* Bundle card tweaks: make image smaller */
    .bundle-card img.bundle-thumb{
      height:180px; /* smaller visual */
      aspect-ratio:auto; /* override default */
      object-fit:cover;
    }

    /* Promo strip */
    .promo-strip{display:flex;gap:.75rem;flex-wrap:wrap;justify-content:center;margin-top:1rem}
    .promo-strip a img{
      width:300px;height:180px;object-fit:cover;border-radius:12px;border:1px solid var(--border);
      box-shadow:var(--shadow);transition:transform .2s ease, box-shadow .2s ease
    }
    .promo-strip a img:hover{transform:translateY(-2px);box-shadow:0 20px 50px rgba(236,72,153,.28)}

    /* Contact panel */
    .contact-panel{
      background:#fff;border:1px solid var(--border);border-radius:var(--radius);
      padding:1rem;box-shadow:var(--shadow)
    }
    .footer{border-top:1px solid var(--border);padding:1.25rem 0;color:var(--muted);font-size:.95rem}
    .social{display:flex;gap:24px;justify-content:center;margin-top:.6rem}
    .social a{color:#a31257;font-size:1.5rem}
    .social a:hover{color:#7a0e40}

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:1rem;z-index:60
    }
    .modal-backdrop.active{display:flex}
    .modal{
      width:min(600px, 100%);background:#fff;border-radius:18px;border:1px solid var(--border);
      box-shadow:0 40px 120px rgba(236,72,153,.3);overflow:hidden;color:var(--text)
    }
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:1rem 1rem .75rem;border-bottom:1px solid var(--border)}
    .modal h3{margin:0;font-size:1.25rem;color:#7a0e40}
    .modal .close{background:transparent;border:0;font-size:1.25rem;line-height:1;cursor:pointer;color:#a31257}
    .modal .content{padding:1rem;display:grid;gap:.8rem}
    .form-row{display:grid;gap:.35rem}
    .form-row label{font-weight:800;font-size:.95rem}
    .form-row select,.form-row input,.form-row textarea{
      width:100%;padding:.6rem .7rem;border-radius:.7rem;border:1px solid #f5cfe0;background:#fff;color:var(--text);outline:none
    }
    .form-row select:focus,.form-row input:focus,.form-row textarea:focus{
      border-color:#f59abf;box-shadow:0 0 0 3px rgba(245,154,191,.25)
    }
    .delivery-row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--border);background:#fff;border-radius:999px;padding:.4rem .65rem;font-weight:700;cursor:pointer
    }
    .chip input{accent-color:#ec4899}
    .calc{
      border-top:1px dashed var(--border);padding-top:.75rem;display:flex;flex-direction:column;gap:.3rem
    }
    .calc .line{display:flex;align-items:center;justify-content:space-between}
    .total{font-weight:900;color:#7a0e40}
    .modal footer{display:flex;gap:.5rem;justify-content:flex-end;padding:1rem;border-top:1px solid var(--border);background:transparent}

    @media (max-width: 900px){
      .hero-inner{grid-template-columns:1fr;padding:1.6rem 0}
      .nav-links .btn{display:none}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container nav">
      <a href="#/" class="brand" aria-label="Clustered by Lee — Home">
        <img id="logoImg" class="logo" alt="Clustered by Lee logo">
        <span class="name">Clustered by Lee</span>
      </a>
      <nav class="nav-links" aria-label="Primary">
        <a href="#/" class="nav-link">Home</a>
        <a href="#/shop" class="nav-link">Shop</a>
        <a href="#contact" class="nav-link">Contact</a>
        <a href="https://wa.me/27660907961" target="_blank" rel="noopener" class="btn btn-small">
          <i class="fa-brands fa-whatsapp"></i> WhatsApp
        </a>
      </nav>
    </div>
  </header>

  <main id="app">
    <!-- Home -->
    <section id="page-home" class="page active" role="region" aria-labelledby="home-title">
      <section class="hero">
        <div class="container hero-inner">
          <div>
            <h1 id="home-title">Pretty. Wispy. Effortless glam.</h1>
            <p>Handcrafted clustered lashes by Lee — soft wispy sets, glam bundles, and easy ordering on WhatsApp with delivery.</p>
            <div class="cta">
              <a href="#/shop" class="btn">Shop the Collection</a>
              <a href="#contact" class="btn btn-outline">Contact</a>
            </div>
          </div>
          <div class="hero-visual">
            <!-- Randomize from your local images; fades in on load -->
            <img id="heroImage" alt="Clustered by Lee featured set"/>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="container">
          <h2>Featured Designs</h2>
          <p class="muted">Faves from Clustered by Lee — tap to order via WhatsApp.</p>
          <div class="grid" id="featuredGrid"></div>

          <div class="promo-strip" aria-label="Promotions">
            <a href="#/shop" title="R70 promotion"><img src="R70.JPG" alt="Promotion R70"></a>
            <a href="#/shop" title="R140 promotion"><img src="R140.JPG" alt="Promotion R140"></a>
            <a href="#/shop" title="R150 promotion"><img src="R150.JPG" alt="Promotion R150"></a>
          </div>
        </div>
      </section>
    </section>

    <!-- Shop -->
    <section id="page-shop" class="page" role="region" aria-labelledby="shop-title">
      <div class="container section">
        <h2 id="shop-title">Shop & Bundles</h2>
        <p class="muted">Bundles include Standard delivery (7–9 business days). Upgrade to Express (3–5 business days) for +R50.</p>

        <h3 style="margin:.5rem 0 0">Bundles & Cart Deals</h3>
        <div class="grid" id="deals-grid" style="margin-bottom:1rem"></div>

        <h3 style="margin:1rem 0 0">Lash Sets</h3>
        <div class="grid" id="shop-grid"></div>
      </div>
    </section>
  </main>

  <!-- Contact / Footer -->
  <footer class="footer" id="contact">
    <div class="container">
      <div class="contact-panel">
        <h3 style="margin-top:0;color:#7a0e40">Contact</h3>
        <p class="muted">
          WhatsApp orders welcome. For wholesale or custom sets, message “Wholesale pack list”.
        </p>
        <p>
          <strong>WhatsApp:</strong>
          <a href="https://wa.me/27660907961" target="_blank" rel="noopener" style="color:#a31257">+27 66 090 7961</a>
        </p>
        <div class="social" aria-label="Social links">
          <a href="https://tiktok.com/@clusteredbylee" target="_blank" rel="noopener" aria-label="TikTok"><i class="fa-brands fa-tiktok"></i></a>
          <a href="https://wa.me/27660907961" target="_blank" rel="noopener" aria-label="WhatsApp"><i class="fa-brands fa-whatsapp"></i></a>
        </div>
      </div>
      <p style="margin:.9rem 0 0" class="muted">© <span id="year"></span> Clustered by Lee. All rights reserved.</p>
    </div>
  </footer>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <h3 id="modalTitle">Select options</h3>
        <button class="close" aria-label="Close" id="modalClose">×</button>
      </header>
      <div class="content" id="modalContent"></div>
      <footer>
        <button class="btn btn-outline" id="modalCancel">Cancel</button>
        <button class="btn" id="modalOrder"><i class="fa-brands fa-whatsapp"></i> Order on WhatsApp</button>
      </footer>
    </div>
  </div>

  <script>
    // Settings
    const WHATSAPP_NUMBER = '27660907961';
    const CURRENCY_SYMBOL = 'R';
    const SHIPPING_PRICE = 50;
    const STANDARD_LABEL = 'Standard 7–9 business days';
    const EXPRESS_LABEL  = 'Express 3–5 business days';

    const formatPrice = (n) => `${CURRENCY_SYMBOL}${n.toFixed(2)}`;

    // Router
    const routes = ['/', '/shop'];
    const routeToPageId = { '/':'page-home', '/shop':'page-shop' };
    function getRouteFromHash(){
      const raw = location.hash.replace('#','').trim();
      if(!raw || raw === '/') return '/';
      const route = raw.startsWith('/') ? raw : '/' + raw;
      return routes.includes(route) ? route : '/';
    }
    function showPage(route){
      Object.values(routeToPageId).forEach(id => document.getElementById(id)?.classList.remove('active'));
      document.getElementById(routeToPageId[route])?.classList.add('active');
      const titles = {'/':'Home','/shop':'Shop'};
      document.title = `Clustered by Lee — ${titles[route] || 'Home'}`;
      document.querySelectorAll('.nav-link').forEach(a=>{
        const isActive = a.getAttribute('href') === '#' + route || (a.getAttribute('href') === '#/' && route === '/');
        a.classList.toggle('active', isActive);
        a.setAttribute('aria-current', isActive ? 'page':'false');
      });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    window.addEventListener('hashchange', ()=>showPage(getRouteFromHash()));

    // Random hero image (from your local images)
    function setRandomHero(){
      const hero = document.getElementById('heroImage');
      const candidates = ['12.jpg','11.jpg','13.jpg','3.jpg','2.jpg','CL.JPG','cl.jpg'];
      // shuffle
      for(let i=candidates.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
      }
      let chosen = candidates[0];
      const test = new Image();
      test.onload = ()=>{ hero.src = chosen; hero.style.opacity = 1; };
      test.onerror = ()=>{
        // fallback to 12.jpg
        hero.src = '12.jpg';
        hero.style.opacity = 1;
      };
      test.src = chosen;
    }

    // Lash Sets
    const products = [
      {
        id:'large-set',
        name:'Large Set',
        price:150.00,
        image:'11.jpg',
        badges:['Glam','Full'],
        description:'Bold fullness for statement glam.',
        options:{ curl:['C','D'], length:[14,16,18,20] }
      },
      {
        id:'medium-set',
        name:'Medium Set',
        price:140.00,
        image:'12.jpg',
        badges:['Balanced','Everyday'],
        description:'Lifted definition with soft finish.',
        options:{ curl:['C','D'], length:[12,14,16,18] }
      },
      {
        id:'classic-set',
        name:'Classic Set',
        price:70.00,
        image:'13.jpg',
        badges:['Natural','Lightweight'],
        description:'Clean, classic lash line for daily wear.',
        options:{ curl:['C'], length:[10,12,14,16] }
      }
    ];

    // Bundles (single card + price list) — image smaller via CSS and one image only
    const bundleGroup = {
      id: 'bundles',
      name: 'Cart Deals — Bundles',
      image: 'bundle.jpg', // single image (smaller via CSS)
      description: 'All bundles include Standard delivery (7–9 business days). Upgrade to Express for +R50.',
      variants: [
        { id:'bundle-1', label:'#1 MINI GLAM BUNDLE — 10 TRAYS', price:460.00 },
        { id:'bundle-2', label:'#2 GLOW UP BUNDLE — 20 TRAYS',  price:860.00 },
        { id:'bundle-3', label:'#3 LASH BOSS SET — 30 TRAYS',   price:1160.00, compareAt:1260.00 },
        { id:'bundle-4', label:'#4 ULTIMATE GLAM SET — 40 TRAYS', price:1300.00, compareAt:1500.00 } // Special
      ]
    };

    // Render: Lash sets
    function renderCards(targetId, items){
      const el = document.getElementById(targetId);
      el.innerHTML = '';
      items.forEach(p=>{
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <img src="${p.image}" alt="${p.name}">
          <div class="card-body">
            <h3>${p.name}</h3>
            <div class="price-row">
              <div><span class="price">${formatPrice(p.price)}</span></div>
              <div style="display:flex;gap:.35rem;flex-wrap:wrap">${(p.badges||[]).map(b=>`<span class="pill">${b}</span>`).join('')}</div>
            </div>
            ${p.description ? `<p class="small" style="margin-top:.4rem">${p.description}</p>` : ''}
          </div>
          <div class="card-actions">
            <button class="btn btn-outline" data-id="${p.id}" data-action="view">Select options</button>
            <button class="btn" data-id="${p.id}" data-action="order"><i class="fa-brands fa-whatsapp"></i> Order</button>
          </div>
        `;
        el.appendChild(card);
      });

      el.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          const action = e.currentTarget.getAttribute('data-action');
          const item = products.find(x=>x.id===id);
          if(!item) return;
          if(action === 'view'){ openModalForItem(item); }
          else if(action === 'order'){ openModalForItem(item, { quick:true }); }
        });
      });
    }

    // Render: Bundles single card
    function renderBundlesCard(){
      const el = document.getElementById('deals-grid');
      el.innerHTML = '';

      const p = bundleGroup;
      const fromPrice = Math.min(...p.variants.map(v=>v.price));
      const hasAnyDiscount = p.variants.some(v => typeof v.compareAt === 'number' && v.compareAt > v.price);

      const listHtml = p.variants.map(v=>{
        const hasDiscount = typeof v.compareAt === 'number' && v.compareAt > v.price;
        const saveAmt = hasDiscount ? (v.compareAt - v.price) : 0;
        return `
          <li style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
            <span>${v.label}</span>
            <span>
              <strong class="price">${formatPrice(v.price)}</strong>
              ${hasDiscount ? `<span class="compare">${formatPrice(v.compareAt)}</span><span class="save">Save ${formatPrice(saveAmt)}</span>` : ''}
            </span>
          </li>
        `;
      }).join('');

      const card = document.createElement('article');
      card.className = 'card bundle-card';
      card.innerHTML = `
        <img class="bundle-thumb" id="bundleThumb" src="${p.image}" alt="Bundles price list">
        <div class="card-body">
          <h3>${p.name}</h3>
          <div class="price-row">
            <div><span class="price">From ${formatPrice(fromPrice)}</span></div>
            <div style="display:flex;gap:.35rem;flex-wrap:wrap">
              <span class="pill">Includes Standard delivery</span>
              <span class="pill">Upgrade to Express +R50</span>
              ${hasAnyDiscount ? `<span class="pill">Special</span>` : ''}
            </div>
          </div>
          <p class="small" style="margin:.4rem 0">${p.description}</p>
          <ul style="list-style:none;padding:0;display:grid;gap:.35rem;margin:.5rem 0 0">
            ${listHtml}
          </ul>
        </div>
        <div class="card-actions">
          <button class="btn btn-outline" data-action="view">Select bundle</button>
          <button class="btn" data-action="order"><i class="fa-brands fa-whatsapp"></i> Order</button>
        </div>
      `;
      el.appendChild(card);

      // Fallback to bundles.jpg if bundle.jpg isn't found
      const img = card.querySelector('#bundleThumb');
      const test = new Image();
      test.onload = ()=>{}; // bundle.jpg exists
      test.onerror = ()=>{ img.src = 'bundles.jpg'; };
      test.src = p.image;

      card.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          const action = e.currentTarget.getAttribute('data-action');
          if(action === 'view'){ openModalForItem(bundleGroup); }
          else if(action === 'order'){ openModalForItem(bundleGroup, { quick:true }); }
        });
      });
    }

    // Featured uses first 3 products
    function renderFeatured(){
      renderCards('featuredGrid', products.slice(0,3));
    }

    // Modal logic
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalContent  = document.getElementById('modalContent');
    const modalClose    = document.getElementById('modalClose');
    const modalCancel   = document.getElementById('modalCancel');
    const modalOrder    = document.getElementById('modalOrder');

    let currentItem = null;
    let quickMode = false;

    function openModalForItem(item, opts = {}){
      currentItem = item;
      quickMode = !!opts.quick;

      const isBundle = Array.isArray(currentItem.variants);
      document.getElementById('modalTitle').textContent = currentItem.name;

      // Build options for sets (curl/length) or bundle selection
      let optionFields = '';
      if(isBundle){
        const options = currentItem.variants.map(v=>{
          const flag = (typeof v.compareAt === 'number' && v.compareAt > v.price) ? ' (Special)' : '';
          return `<option value="${v.id}">${v.label}${flag} — ${formatPrice(v.price)}</option>`;
        }).join('');
        optionFields += `
          <div class="form-row">
            <label for="opt_variant">Select bundle</label>
            <select id="opt_variant" name="bundle">${options}</select>
          </div>
        `;
      }else{
        const optsMap = currentItem.options || {};
        const labelMap = { curl:'Curl', length:'Length (mm)', variant:'Variant' };
        optionFields += Object.keys(optsMap).map(key=>{
          const values = optsMap[key];
          const options = values.map(v=>`<option value="${v}">${v}</option>`).join('');
          return `
            <div class="form-row">
              <label for="opt_${key}">${labelMap[key] || key}</label>
              <select id="opt_${key}" name="${key}">
                ${options}
              </select>
            </div>
          `;
        }).join('');
      }

      const unitLabel = isBundle ? 'per bundle' : 'per set';
      const unitPrice = isBundle ? getSelectedVariant(currentItem)?.price : currentItem.price;

      // Delivery options
      const deliveryFields = isBundle
        ? `
          <label class="chip">
            <input type="radio" name="delivery" value="standard" checked> ${STANDARD_LABEL} (Included)
          </label>
          <label class="chip">
            <input type="radio" name="delivery" value="express"> ${EXPRESS_LABEL} (+${formatPrice(SHIPPING_PRICE)})
          </label>
        `
        : `
          <label class="chip">
            <input type="radio" name="delivery" value="none" checked> Pickup / arrange later (R0)
          </label>
          <label class="chip">
            <input type="radio" name="delivery" value="express"> ${EXPRESS_LABEL} (+${formatPrice(SHIPPING_PRICE)})
          </label>
        `;

      modalContent.innerHTML = `
        <div class="form-row">
          <div class="small">Price</div>
          <div class="price" id="unitPrice">${formatPrice(unitPrice)} <span class="small">${unitLabel}</span></div>
        </div>

        ${optionFields}

        <div class="form-row">
          <label for="opt_qty">Quantity</label>
          <input id="opt_qty" type="number" min="1" step="1" value="1">
        </div>

        <div class="form-row">
          <label>Delivery</label>
          <div class="delivery-row">
            ${deliveryFields}
          </div>
        </div>

        <div class="form-row">
          <label for="opt_notes">Notes (optional)</label>
          <textarea id="opt_notes" rows="3" placeholder="E.g., prefer D curl, please include extra 14mm"></textarea>
        </div>

        <div class="calc">
          <div class="line"><span>Items subtotal</span><strong id="calcSubtotal">${formatPrice(unitPrice)}</strong></div>
          <div class="line"><span>Delivery</span><strong id="calcShipping">${formatPrice(0)}</strong></div>
          <div class="line total"><span>Total</span><strong id="calcTotal">${formatPrice(unitPrice)}</strong></div>
        </div>
      `;

      // Events for live updates
      const qtyEl = modalContent.querySelector('#opt_qty');
      qtyEl.addEventListener('input', updateTotals);

      modalContent.querySelectorAll('input[name="delivery"]').forEach(r => r.addEventListener('change', updateTotals));

      if(isBundle){
        modalContent.querySelector('#opt_variant').addEventListener('change', ()=>{
          const v = getSelectedVariant(currentItem);
          document.getElementById('unitPrice').innerHTML = `${formatPrice(v.price)} <span class="small">${unitLabel}</span>`;
          updateTotals();
        });
      }

      updateTotals();
      showModal();
      if(quickMode){ setTimeout(()=>modalOrder.focus(), 30); }
    }

    function getSelectedVariant(item){
      if(!item || !Array.isArray(item.variants)) return null;
      const id = document.getElementById('opt_variant')?.value;
      return item.variants.find(v=>v.id===id) || item.variants[0];
    }

    function updateTotals(){
      if(!currentItem) return;
      const isBundle = Array.isArray(currentItem.variants);
      const qty = Math.max(1, parseInt(document.getElementById('opt_qty')?.value || '1', 10));
      const deliveryVal = [...modalContent.querySelectorAll('input[name="delivery"]')].find(r=>r.checked)?.value || (isBundle ? 'standard' : 'none');
      const shipping = deliveryVal === 'express' ? SHIPPING_PRICE : 0;

      const unitPrice = isBundle ? getSelectedVariant(currentItem).price : currentItem.price;
      const subtotal = unitPrice * qty;
      const total = subtotal + shipping;

      document.getElementById('calcSubtotal').textContent = formatPrice(subtotal);
      document.getElementById('calcShipping').textContent = formatPrice(shipping);
      document.getElementById('calcTotal').textContent = formatPrice(total);
    }

    function showModal(){
      modalBackdrop.classList.add('active');
      modalBackdrop.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
      modalBackdrop.classList.remove('active');
      modalBackdrop.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      currentItem = null;
      quickMode = false;
    }
    modalClose.addEventListener('click', closeModal);
    modalCancel.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modalBackdrop.classList.contains('active')) closeModal(); });

    function orderOnWhatsApp(){
      if(!currentItem) return;

      const isBundle = Array.isArray(currentItem.variants);
      const qty = Math.max(1, parseInt(document.getElementById('opt_qty')?.value || '1', 10));
      const notes = (document.getElementById('opt_notes')?.value || '').trim();
      const deliveryVal = [...modalContent.querySelectorAll('input[name="delivery"]')].find(r=>r.checked)?.value || (isBundle ? 'standard' : 'none');
      const shipping = deliveryVal === 'express' ? SHIPPING_PRICE : 0;

      let titleLine = '';
      if(isBundle){
        const v = getSelectedVariant(currentItem);
        titleLine = `• Bundle: ${v.label}`;
      }else{
        titleLine = `• Product: ${currentItem.name}`;
      }

      const selections = [];
      if(!isBundle){
        const optsMap = currentItem.options || {};
        Object.keys(optsMap).forEach(key=>{
          const el = document.getElementById('opt_' + key);
          if(el){ selections.push(`${(key[0].toUpperCase()+key.slice(1))}: ${el.value}`); }
        });
      }

      const unitPrice = isBundle ? getSelectedVariant(currentItem).price : currentItem.price;
      const subtotal = unitPrice * qty;
      const deliveryText = isBundle
        ? (deliveryVal === 'express'
            ? `${EXPRESS_LABEL} (+${formatPrice(SHIPPING_PRICE)})`
            : `${STANDARD_LABEL} (Included)`)
        : (deliveryVal === 'express'
            ? `${EXPRESS_LABEL} (+${formatPrice(SHIPPING_PRICE)})`
            : 'Pickup / arrange later (R0)');

      const lines = [
        'Hi Clustered by Lee 👋 I’d like to order:',
        titleLine,
        selections.length ? `• Options: ${selections.join(', ')}` : '',
        `• Quantity: ${qty}`,
        `• Subtotal: ${formatPrice(subtotal)}`,
        `• Delivery: ${deliveryText}`,
        `• Total: ${formatPrice(subtotal + shipping)}`,
        notes ? `• Notes: ${notes}` : '',
        '',
        'Please let me know the next steps. Thank you!'
      ].filter(Boolean);

      const msg = encodeURIComponent(lines.join('\n'));
      const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
      window.open(url, '_blank', 'noopener');
      closeModal();
    }
    modalOrder.addEventListener('click', orderOnWhatsApp);

    // Logo load: CL.JPG if present, else text fallback
    function loadLogo(){
      const imgEl = document.getElementById('logoImg');
      const saved = localStorage.getItem('siteLogo'); // optional dataURL or path
      if(saved){ imgEl.src = saved; return; }
      const probe = new Image();
      probe.onload = ()=>{ imgEl.src = 'CL.JPG'; };
      probe.onerror = ()=>{ imgEl.remove(); };
      probe.src = 'CL.JPG';
    }

    // Init
    window.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('year').textContent = new Date().getFullYear();
      loadLogo();
      setRandomHero();

      renderCards('shop-grid', products);
      renderBundlesCard();
      renderFeatured();

      if(!location.hash){ location.hash = '#/'; } else { showPage(getRouteFromHash()); }
    });
  </script>
</body>
</html>
